name: TSF Validation

on:
  pull_request:  # Only run on PRs - KISS principle

jobs:
  tsf-validation:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Setup Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ Install TSF tools
      - name: Install TSF tools
        run: |
          pip install pyyaml
          git clone https://gitlab.com/CodethinkLabs/trustable/trustable.git /tmp/trustable
          cd /tmp/trustable
          git checkout 2025.9.16 || git checkout main
          pip install .

      # 4ï¸âƒ£ Run trudag lint
      - name: Run trudag lint
        id: lint
        run: |
          mkdir -p artifacts
          trudag manage lint 2>&1 | tee artifacts/trudag-lint.txt

      # 5ï¸âƒ£ Run trudag score
      - name: Calculate scores
        id: score
        continue-on-error: true
        run: |
          trudag score 2>&1 | tee artifacts/trudag-score.txt

      # 6ï¸âƒ£ Generate report
      - name: Generate report
        id: publish
        continue-on-error: true
        run: |
          mkdir -p artifacts/trustable-report
          trudag publish --output-dir artifacts/trustable-report || true

      # 7ï¸âƒ£ Upload artifacts (for debugging)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-artifacts
          path: artifacts/
          retention-days: 7

      # 8ï¸âƒ£ Comment on PR
      - name: Comment PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ” TSF Validation

            | Check | Status |
            |-------|--------|
            | **trudag lint** | ${{ steps.lint.outcome == 'success' && 'âœ…' || 'âŒ' }} |
            | **trudag score** | ${{ steps.score.outcome == 'success' && 'âœ…' || 'âš ï¸' }} |
            | **trudag publish** | ${{ steps.publish.outcome == 'success' && 'âœ…' || 'âš ï¸' }} |

            <details>
            <summary>ğŸ“‹ Lint Output</summary>

            ```
            $(cat artifacts/trudag-lint.txt 2>/dev/null || echo "No output")
            ```
            </details>

            ğŸ“Š [Download artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # 9ï¸âƒ£ Fail if lint fails
      - name: Check result
        run: |
          if [ "${{ steps.lint.outcome }}" != "success" ]; then
            echo "âŒ Lint failed"
            exit 1
          fi
