name: TSF Validation (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-verification-artifacts:
    uses: ./.github/workflows/generate_verification_artifacts.yml
    with:
      src_dirs: 'src'
      junit_output: 'artifacts/verification/tests/LLTC-998-junit.xml'
      coverage_output: 'artifacts/verification/coverage/coverage-SWD-998.xml'
      cppcheck_output: 'artifacts/verification/static-analysis/cppcheck-SWD-998.xml'
      build_dir: 'build'

  tsf-validation:
    needs: generate-verification-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download verification artifacts produced earlier
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          path: artifacts/verification # This path must match the upload

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install project (editable) and Trustable (from GitLab Registry)
        run: |
          set -euo pipefail

          echo "=== Upgrade pip, setuptools, wheel ==="
          python -m pip install --upgrade pip setuptools wheel

          echo "=== Installing project in editable mode ==="
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            python -m pip install -e . --verbose
          fi

          echo "=== Installing testing dependencies ==="
          python -m pip install pytest pytest-cov pyyaml gcovr --verbose

          echo "=== Installing trustable from GitLab registry ==="
          python -m pip install trustable --index-url https://gitlab.com/api/v4/projects/66600816/packages/pypi/simple --verbose

          echo "=== Listing installed packages ==="
          python -m pip list

          echo "=== Checking Python sys.path ==="
          python -c "import sys; print('\n'.join(sys.path))"

          echo "=== Listing src directory contents ==="
          ls -R src

          echo "=== Verifying trudag installation ==="
          python -m trudag --version

          echo "=== Listing validators from trudag ==="
          python -c "
          from trudag.dotstop.core.validator import Validator
          v = Validator()
          print('Discovered validators:')
          for name, func in v._validator_functions.items():
              print(f'  ✓ {name}: {func}')
          "

      - name: Run trudag lint (optional)
        id: trudag_lint
        continue-on-error: true # Linting is allowed to be optional
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report
          trudag manage lint 2>&1 | tee artifacts/trustable-report/trudag-lint.txt || true
          echo "lint_done=true" >> $GITHUB_OUTPUT

      - name: Calculate TSF scores (use local tools/tsf_collect.py if present)
        id: score
        # CRITICAL: Removed 'continue-on-error: true'.
        # If scoring fails, the workflow MUST fail.
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report

          # This 'if' block (Risk 2.4) is fine.
          # Your 'ls -R' shows this file doesn't exist, so the 'else' block
          # (trudag score) will be correctly executed.
          if python -c "import importlib, pkgutil, sys; sys.path.insert(0,'.'); importlib.import_module('tools.tsf_collect')" 2>/dev/null; then
            echo "Running local tools.tsf_collect"
            python -m tools.tsf_collect --output artifacts/trustable-report/tsf_score.json --text artifacts/trustable-report/tsf_score.txt
            SCORE_EXIT=$?
          else
            echo "Local tsf_collect not found — using trudag score"
            trudag score 2>&1 | tee artifacts/trustable-report/trudag-score.txt
            SCORE_EXIT=${PIPESTATUS}
            if [ -f artifacts/trustable-report/trudag-score.txt ]; then
              cp artifacts/trustable-report/trudag-score.txt artifacts/trustable-report/tsf_score.txt || true
            fi
          fi

          echo "score_exit_code=${SCORE_EXIT}" >> $GITHUB_OUTPUT
          if; then
            echo "::error::Score calculation returned non-zero (${SCORE_EXIT})"
            exit 1
          fi

          if [! -s "artifacts/trustable-report/tsf_score.txt" ]; then
            echo "::error::TSF score file not found or is empty!"
            exit 1
          fi
          echo "TSF score generated successfully."

      - name: Generate trustable publish (optional)
        id: publish
        continue-on-error: true # Publishing is allowed to be optional
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report
          trudag publish --output-dir artifacts/trustable-report --no-validate 2>&1 | tee artifacts/trustable-report/publish.log || true

      - name: Upload TSF validation artifacts
        uses: actions/upload-artifact@v4
        if: always() # Upload artifacts even on failure for debugging
        with:
          name: tsf-validation-artifacts
          path: artifacts/
          retention-days: 30

      - name: Display summary
        if: always() # Show summary even on failure
        run: |
          echo "=== TSF Validation Summary ==="
          echo "Artifacts:"
          find artifacts -type f | sed -n '1,200p'
          echo ""
          if [ -f artifacts/trustable-report/tsf_score.txt ]; then
            echo "=== TSF Score (.txt) ==="
            head -n 200 artifacts/trustable-report/tsf_score.txt || true
          elif [ -f artifacts/trustable-report/trudag-score.txt ]; then
            echo "=== Trudag Score ==="
            head -n 200 artifacts/trustable-report/trudag-score.txt || true
          fi
          echo "============================="
