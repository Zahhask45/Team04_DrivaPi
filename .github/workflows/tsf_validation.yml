name: TSF Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-verification-artifacts:
    uses: ./.github/workflows/generate_verification_artifacts.yml
    with:
      use_cmake: 'true'
      cmake_build_dir: 'build'
      build_type: 'Debug'
      test_binary: 'build/motor_speed_test'
      junit_output: 'artifacts/verification/tests/LLTC-998-junit.xml'
      coverage_output: 'artifacts/verification/coverage/coverage-SWD-998.xml'
      cppcheck_output: 'artifacts/verification/static-analysis/cppcheck-SWD-998.xml'
      src_dirs: 'src'
      run_cppcheck: 'true'
      run_coverage: 'true'
      enable_coverage_flags: 'true'

  tsf-validation:
    needs: generate-verification-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # For posting PR comments if desired

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download verification artifacts produced earlier
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          path: artifacts/verification

      - name: Validate downloaded artifacts
        id: validate_artifacts
        run: |
          echo "=== Verification Artifacts ==="

          # Check for expected files
          EXPECTED_FILES=(
            "artifacts/verification/tests/LLTC-998-junit.xml"
            "artifacts/verification/coverage/coverage-SWD-998.xml"
            "artifacts/verification/static-analysis/cppcheck-SWD-998.xml"
          )

          ALL_PRESENT=true
          for file in "\${EXPECTED_FILES[@]}"; do
            if [ -f "\$file" ]; then
              SIZE=\$(stat -f%z "\$file" 2>/dev/null || stat -c%s "\$file")
              echo "‚úì Found: \$file (\${SIZE} bytes)"
            else
              echo "‚úó Missing: \$file"
              ALL_PRESENT=false
            fi
          done

          # List all files found
          echo ""
          echo "=== All Verification Files ==="
          find artifacts/verification -type f -print || echo "No files found"
          echo "========================="

          if [ "\$ALL_PRESENT" = "false" ]; then
            echo "::warning::Some expected verification artifacts are missing"
          fi

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies + make local validators importable
        run: |
          python -m pip install --upgrade pip

          # Install project in editable mode if setup.py/pyproject.toml exists
          if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            pip install -e .
          fi

          # Install trudag and dependencies
          pip install trudag pytest pytest-cov pyyaml

      - name: Verify trudag installation
        run: |
          echo "Checking trudag installation..."
          trudag --version || echo "trudag command not found"
          python -c "import trudag; print(f'trudag module version: {trudag.__version__}')" || echo "trudag module not importable"

      - name: Run trudag lint
        id: trudag_lint
        continue-on-error: true  # Lint warnings shouldn't fail the build
        run: |
          mkdir -p artifacts/trustable-report

          echo "Running trudag lint..."
          trudag manage lint 2>&1 | tee artifacts/trustable-report/trudag-lint.txt

          # Capture exit code but don't fail
          LINT_EXIT=\${PIPESTATUS[0]}
          echo "lint_exit_code=\${LINT_EXIT}" >> \$GITHUB_OUTPUT

          if [ \${LINT_EXIT} -ne 0 ]; then
            echo "::warning::trudag lint found issues (exit code: \${LINT_EXIT})"
          fi

      - name: Calculate TSF scores
        id: score
        run: |
          set +e  # Don't exit immediately on error

          mkdir -p artifacts/trustable-report

          # Check if local tsf_collect exists
          HAS_LOCAL_COLLECT=false
          if python -c "from tools import tsf_collect" 2>/dev/null; then
            HAS_LOCAL_COLLECT=true
            echo "Found local tsf_collect module"
          fi

          # Run scoring
          if [ "\$HAS_LOCAL_COLLECT" = "true" ]; then
            echo "Using local tsf_collect..."
            python -m tools.tsf_collect \
              --output artifacts/trustable-report/tsf_score.json \
              --text artifacts/trustable-report/tsf_score.txt
            SCORE_EXIT=\$?
          else
            echo "Using trudag score..."
            trudag score 2>&1 | tee artifacts/trustable-report/trudag-score.txt
            SCORE_EXIT=\${PIPESTATUS[0]}

            # Copy score output if trudag score was used
            if [ -f "artifacts/trustable-report/trudag-score.txt" ]; then
              cp artifacts/trustable-report/trudag-score.txt artifacts/trustable-report/tsf_score.txt
            fi
          fi

          echo "score_exit_code=\${SCORE_EXIT}" >> \$GITHUB_OUTPUT

          if [ \${SCORE_EXIT} -ne 0 ]; then
            echo "::error::TSF score calculation failed with exit code \${SCORE_EXIT}"
            exit 1
          fi

      - name: Generate trustable report
        id: publish
        continue-on-error: true  # Report generation issues shouldn't fail if we have scores
        run: |
          mkdir -p artifacts/trustable-report

          echo "Generating trustable report..."
          trudag publish \
            --output-dir artifacts/trustable-report \
            --no-validate \
            2>&1 | tee artifacts/trustable-report/publish.log

          PUBLISH_EXIT=\${PIPESTATUS[0]}
          echo "publish_exit_code=\${PUBLISH_EXIT}" >> \$GITHUB_OUTPUT

          if [ \${PUBLISH_EXIT} -ne 0 ]; then
            echo "::warning::trudag publish encountered issues (exit code: \${PUBLISH_EXIT})"
          fi

      - name: Upload TSF validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-validation-artifacts
          path: artifacts/
          retention-days: 30

      - name: Display validation summary
        if: always()
        run: |
          echo "=========================================="
          echo "üîç TSF VALIDATION SUMMARY"
          echo "=========================================="
          echo ""

          # Show file structure
          echo "üìÅ Generated Files:"
          find artifacts -type f -name "*.txt" -o -name "*.json" -o -name "*.xml" | head -n 50
          echo ""

          # Show trudag lint results
          if [ -f "artifacts/trustable-report/trudag-lint.txt" ]; then
            echo "üìã Trudag Lint Results (first 20 lines):"
            echo "------------------------------------------"
            head -n 20 artifacts/trustable-report/trudag-lint.txt
            echo ""
          fi

          # Show score results
          if [ -f "artifacts/trustable-report/tsf_score.txt" ]; then
            echo "üìä TSF Score Results (first 30 lines):"
            echo "------------------------------------------"
            head -n 30 artifacts/trustable-report/tsf_score.txt
            echo ""
          elif [ -f "artifacts/trustable-report/trudag-score.txt" ]; then
            echo "üìä Trudag Score Results (first 30 lines):"
            echo "------------------------------------------"
            head -n 30 artifacts/trustable-report/trudag-score.txt
            echo ""
          fi

          # Show exit codes
          echo "üî¢ Exit Codes:"
          echo "------------------------------------------"
          echo "Lint: \${{ steps.trudag_lint.outputs.lint_exit_code || 'N/A' }}"
          echo "Score: \${{ steps.score.outputs.score_exit_code || 'N/A' }}"
          echo "Publish: \${{ steps.publish.outputs.publish_exit_code || 'N/A' }}"
          echo ""

          echo "=========================================="

          # Determine overall status
          SCORE_EXIT=\${{ steps.score.outputs.score_exit_code || '0' }}

          if [ "\$SCORE_EXIT" != "0" ]; then
            echo "‚ùå TSF Validation FAILED"
            exit 1
          else
            echo "‚úÖ TSF Validation PASSED"
          fi
