name: TSF Validation (PR)

on:
  workflow_run:
    workflows: ["Unit Tests & TSF Artifacts"]
    types:
      - completed

jobs:
  tsf-validation:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download Verification Artifacts
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts/verification

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-trustable-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-trustable-

      - name: Install official TSF tools
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          git clone https://gitlab.com/CodethinkLabs/trustable/trustable.git /tmp/trustable
          cd /tmp/trustable
          git fetch --tags || true
          git checkout 2025.9.16 || git checkout master || echo "Using available branch"
          pip install .
          cd -

      - name: Install local validators
        run: pip install -e Dotstop

      - name: Create temporary symlink to .dotstop.dot
        run: ln -sf Dotstop/.dotstop.dot .dotstop.dot

      - name: Mark TSF items and links as reviewed
        run: |
          # --- SPEED SENSOR ---
          
          # --- SERVOMOTOR (Actuation) ---

      - name: Run trudag lint
        id: lint
        continue-on-error: true
        run: |
          mkdir -p artifacts/tsf
          if trudag manage lint 2>&1 | tee artifacts/tsf/trudag-lint.txt; then
            echo "lint_ok=true" >> $GITHUB_OUTPUT
          else
            echo "lint_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Get lint summary
        id: summary
        run: |
          if [ -f artifacts/tsf/trudag-lint.txt ]; then
            echo "lint_summary<<EOF" >> $GITHUB_OUTPUT
            head -c 500 artifacts/tsf/trudag-lint.txt >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "lint_summary=No lint output generated" >> $GITHUB_OUTPUT
          fi

      - name: Calculate trust scores
        id: scores
        continue-on-error: true
        run: |
          if trudag score 2>&1 | tee artifacts/tsf/trudag-score.txt; then
            echo "score_ok=true" >> $GITHUB_OUTPUT
          else
            echo "score_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Trustable report (publish)
        id: publish
        continue-on-error: true
        run: |
          mkdir -p artifacts/tsf/trustable-report
          if trudag publish --output-dir artifacts/tsf/trustable-report 2>&1; then
            echo "publish_ok=true" >> $GITHUB_OUTPUT
          elif trudag publish --no-validate --output-dir artifacts/tsf/trustable-report 2>&1; then
            echo "publish_ok=true" >> $GITHUB_OUTPUT
          else
            echo "publish_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload TSF artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: tsf-validation-artifacts
          path: |
            artifacts/tsf/
            .dotstop.dot
          retention-days: 30

      - name: Comment PR with validation results
        if: github.event.workflow_run.pull_requests[0]
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          body: |
            ## ğŸ” TSF Validation Results

            | Check | Status |
            |-------|--------|
            | **trudag lint** | ${{ steps.lint.outputs.lint_ok == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }} |
            | **trudag score** | ${{ steps.scores.outputs.score_ok == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }} |
            | **trudag publish** | ${{ steps.publish.outputs.publish_ok == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }} |

            ### ğŸ“‹ Lint Output (first 500 chars)
            ```
            ${{ steps.summary.outputs.lint_summary }}
            ```

            **Artifacts**: [TSF Validation Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
