name: TSF Validation (PR)

on:
  pull_request:
  push:
    branches: [ main, master]
  pull_request_review:
    types: [submitted]

jobs:
  generate-verification-artifacts:
    uses: ./.github/workflows/generate_verification_artifacts.yml
    with:
      src_dirs: 'src'
      junit_output: 'artifacts/verification/tests/LLTC-998-junit.xml'
      coverage_output: 'artifacts/verification/coverage/coverage-SWD-998.xml'
      cppcheck_output: 'artifacts/verification/static-analysis/cppcheck-SWD-998.xml'
      build_dir: 'build'

  tsf-validation:
    needs: generate-verification-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1bÔ∏è‚É£ Download verification artifacts from previous job
      - name: Download verification artifacts
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          path: artifacts/verification

      # 1cÔ∏è‚É£ Verify artifacts were downloaded
      - name: Verify downloaded artifacts
        run: |
          echo "=== Checking for required artifacts ==="
          ls -lR artifacts/ 2>/dev/null || echo "No artifacts directory"

          echo ""
          echo "=== Checking specific files ==="
          for f in \
            "artifacts/verification/tests/LLTC-998-junit.xml" \
            "artifacts/verification/coverage/coverage-SWD-998.xml" \
            "artifacts/verification/static-analysis/cppcheck-SWD-998.xml"
          do
            if [ -f "$f" ]; then
              echo "‚úÖ Found: $f ($(stat -c%s "$f" 2>/dev/null || stat -f%z "$f") bytes)"
              echo "   First 200 chars:"
              head -c 200 "$f"
              echo ""
            else
              echo "‚ùå MISSING: $f"
            fi
          done

      # 2Ô∏è‚É£ Setup Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Cache pip
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4Ô∏è‚É£ Install TSF/trudag tools
      - name: Install official TSF tools
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          git clone https://gitlab.com/CodethinkLabs/trustable/trustable.git /tmp/trustable
          cd /tmp/trustable
          git fetch --tags || true
          git checkout 2025.9.16 || git checkout master || echo "Using available branch"
          pip install .
          cd -

      # 4bÔ∏è‚É£ Install local validators
      - name: Install local validators
        run: |
          pip install -e .
          echo ""
          echo "=== Testing validator import ==="
          python -c "from dotstop_extensions.validators import coverage_threshold_validator, cppcheck_error_validator, junit_pass_rate_validator; print('‚úÖ All validators loaded successfully')"

      # 5Ô∏è‚É£ Verify tools
      - name: Verify tools installation
        run: |
          echo "trudag version:"
          trudag --version || echo "trudag not found"

      # 5bÔ∏è‚É£ Debug: Test validators manually
      - name: Debug validator execution
        run: |
          echo "=== Testing validators directly ==="
          python3 << 'EOPYTHON'
          from dotstop_extensions.validators import (
              junit_pass_rate_validator,
              coverage_threshold_validator,
              cppcheck_error_validator
          )
          import os

          # Test each validator
          print("\n1. Testing JUnit validator:")
          junit_path = "artifacts/verification/tests/LLTC-998-junit.xml"
          print(f"   File exists: {os.path.exists(junit_path)}")
          if os.path.exists(junit_path):
              config = {
                  "min_pass_rate": 100,
                  "references": [{"path": junit_path}]
              }
              score, errors = junit_pass_rate_validator(config)
              print(f"   Score: {score}, Errors: {errors}")

          print("\n2. Testing Coverage validator:")
          cov_path = "artifacts/verification/coverage/coverage-SWD-998.xml"
          print(f"   File exists: {os.path.exists(cov_path)}")
          if os.path.exists(cov_path):
              config = {
                  "min_line_rate": 80,
                  "references": [{"path": cov_path}]
              }
              score, errors = coverage_threshold_validator(config)
              print(f"   Score: {score}, Errors: {errors}")

          print("\n3. Testing Cppcheck validator:")
          cpp_path = "artifacts/verification/static-analysis/cppcheck-SWD-998.xml"
          print(f"   File exists: {os.path.exists(cpp_path)}")
          if os.path.exists(cpp_path):
              config = {
                  "fail_on_severity": ["error"],
                  "references": [{"path": cpp_path}]
              }
              score, errors = cppcheck_error_validator(config)
              print(f"   Score: {score}, Errors: {errors}")
          EOPYTHON

      # 6Ô∏è‚É£ Run trudag lint (capture output)
      - name: Run trudag lint
        id: lint
        continue-on-error: true
        run: |
          mkdir -p artifacts
          echo "=== trudag manage lint (second pass for validation) ===" > artifacts/trudag-lint.txt
          if trudag manage lint 2>&1 | tee -a artifacts/trudag-lint.txt; then
            echo "lint_ok=true" >> $GITHUB_OUTPUT
          else
            echo "lint_ok=false" >> $GITHUB_OUTPUT
          fi

      # 6b. Get lint summary for PR comment
      - name: Get lint summary
        id: summary
        run: |
          if [ -f artifacts/trudag-lint.txt ]; then
            echo "lint_summary<<EOF" >> $GITHUB_OUTPUT
            head -c 500 artifacts/trudag-lint.txt >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "lint_summary=No lint output generated" >> $GITHUB_OUTPUT
          fi

      # 7Ô∏è‚É£ Calculate trust scores
      - name: Calculate trust scores
        id: scores
        continue-on-error: true
        run: |
          if trudag score 2>&1 | tee artifacts/trudag-score.txt; then
            echo "score_ok=true" >> $GITHUB_OUTPUT
          else
            echo "score_ok=false" >> $GITHUB_OUTPUT
          fi

      # 8Ô∏è‚É£ Generate Trustable report
      - name: Generate Trustable report (publish)
        id: publish
        continue-on-error: true
        run: |
          mkdir -p artifacts/trustable-report
          if trudag publish --output-dir artifacts/trustable-report 2>&1; then
            echo "publish_ok=true" >> $GITHUB_OUTPUT
          elif trudag publish --no-validate --output-dir artifacts/trustable-report 2>&1; then
            echo "publish_ok=true" >> $GITHUB_OUTPUT
          else
            echo "publish_ok=false" >> $GITHUB_OUTPUT
            echo "publish failed or not configured"
          fi

      # 9Ô∏è‚É£ List artifacts for debug
      - name: List artifacts
        run: |
          echo "Artifacts directory listing:"
          ls -la artifacts || true
          echo ""
          echo ".dotstop.dot present?"
          [ -f .dotstop.dot ] && echo "YES" || echo "NO"
          echo ""
          echo "Requirements count:"
          find reqs/ -name "*.md" 2>/dev/null | wc -l || echo "0"

      # üîü Upload TSF artifacts
      - name: Upload TSF artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-validation-artifacts
          path: |
            artifacts/
            .dotstop.dot
          retention-days: 30

      # 1Ô∏è‚É£1Ô∏è‚É£ Comment PR with validation results
      - name: Comment PR with validation results
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üîç TSF Validation Results

            | Check | Status |
            |-------|--------|
            | **trudag lint** | ${{ steps.lint.outputs.lint_ok == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }} |
            | **trudag score** | ${{ steps.scores.outputs.score_ok == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }} |
            | **trudag publish** | ${{ steps.publish.outputs.publish_ok == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }} |

            ### üìã Lint Output (first 500 chars)

            ```
            ${{ steps.summary.outputs.lint_summary }}
            ```

            ### üìä Artifacts

            Full validation artifacts are available for download:
            - Go to **Actions** tab
            - Select this workflow run
            - Download **tsf-validation-artifacts**

            ### üìö Documentation

            - [TSF Quick Reference](https://github.com/${{ github.repository }}/blob/master/docs/tsf/reference.md)
            - [Fix Common Errors](https://github.com/${{ github.repository }}/blob/master/docs/tsf/workflow.md#fix-common-errors)

            ---
            *Validation run: ${{ github.run_id }} | Commit: ${{ github.sha }}*

      # 1Ô∏è‚É£2Ô∏è‚É£ Fail job if lint failed (optional - comment out if too strict)
      - name: Check lint result
        if: steps.lint.outputs.lint_ok != 'true'
        run: |
          echo "‚ùå trudag manage lint FAILED"
          echo "See artifacts for full output"
          exit 1
