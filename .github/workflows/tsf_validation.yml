name: TSF Validation (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-verification-artifacts:
    uses: ./.github/workflows/generate_verification_artifacts.yml
    with:
      src_dirs: 'src'
      junit_output: 'artifacts/verification/tests/LLTC-998-junit.xml'
      coverage_output: 'artifacts/verification/coverage/coverage-SWD-998.xml'
      cppcheck_output: 'artifacts/verification/static-analysis/cppcheck-SWD-998.xml'
      build_dir: 'build'

  tsf-validation:
    needs: generate-verification-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download verification artifacts produced earlier
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          path: artifacts/verification

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install project (editable) and Trustable (from GitLab Registry)
        run: |
          set -euo pipefail

          echo "=== Upgrade pip, setuptools, wheel ==="
          python -m pip install --upgrade pip setuptools wheel

          echo "=== Installing project in editable mode ==="
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            python -m pip install -e . --verbose
          fi

          echo "=== Installing testing dependencies ==="
          python -m pip install pytest pytest-cov pyyaml gcovr --verbose

          echo "=== Installing trustable from GitLab registry ==="
          python -m pip install trustable --index-url https://gitlab.com/api/v4/projects/66600816/packages/pypi/simple --verbose

          echo "=== Listing installed packages ==="
          python -m pip list

          echo "=== Checking Python sys.path ==="
          python -c "import sys; print('\n'.join(sys.path))"

          echo "=== Listing src directory contents ==="
          ls -R src

          echo "=== Verifying trudag installation ==="
          trudag --version

          echo "=== Listing validators from trudag ==="
          python -c "
          from trudag.dotstop.core.validator import Validator
          v = Validator()
          print('Discovered validators:')
          for name, func in v._validator_functions.items():
              print(f'  ✓ {name}: {func}')
          "

      - name: Check for .dotstop.dot in repository
        id: check_dot
        run: |
          if [ -f ".dotstop.dot" ]; then
            echo "✓ .dotstop.dot found in repository"
            ls -lh .dotstop.dot
            echo "dot_exists=true" >> $GITHUB_OUTPUT
          else
            echo "✗ .dotstop.dot NOT found in repository"
            echo "dot_exists=false" >> $GITHUB_OUTPUT
          fi
          cat .dotstop.dot || true

      - name: Build TSF graph (if .dotstop.dot missing or needs update)
        id: build_graph
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report

          if [ -f ".dotstop.dot" ]; then
            echo "=== Using existing .dotstop.dot from repository ==="
            echo "Running trudag manage lint to validate..."
            trudag manage lint 2>&1 | tee artifacts/trustable-report/trudag-lint.txt || true
            echo "✓ Existing .dotstop.dot preserved with all metadata"
          else
            echo "=== Building TSF graph from requirement YAML files ==="
            trudag manage lint 2>&1 | tee artifacts/trustable-report/trudag-lint.txt

            if [ ! -f ".dotstop.dot" ]; then
              echo "::error::.dotstop.dot file was not created!"
              exit 1
            fi
            echo "✓ TSF graph built successfully"
          fi

          ls -lh .dotstop.dot

      - name: Verify verification artifacts are accessible
        run: |
          set -euo pipefail

          echo "=== Verifying verification artifacts ==="
          echo "Working directory: $(pwd)"
          echo ""
          echo "Required artifact files:"

          REQUIRED_FILES=(
            "artifacts/verification/coverage/coverage-SWD-998.xml"
            "artifacts/verification/static-analysis/cppcheck-SWD-998.xml"
            "artifacts/verification/tests/LLTC-998-junit.xml"
          )

          ALL_PRESENT=true
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file"
            else
              echo "  ✗ $file (MISSING)"
              ALL_PRESENT=false
            fi
          done

          if [ "$ALL_PRESENT" = false ]; then
            echo "::error::Some required artifact files are missing!"
            exit 1
          fi

      - name: Calculate TSF scores
        id: score
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report

          echo "=== Calculating TSF scores ==="
          echo "Using trudag score to process evidence and run validators"

          # Run trudag score with output logging
          trudag score 2>&1 | tee artifacts/trustable-report/trudag-score.txt
          SCORE_EXIT=${PIPESTATUS[0]}

          echo ""
          echo "=== Score calculation exit code: $SCORE_EXIT ==="

          if [ $SCORE_EXIT -ne 0 ]; then
            echo "::error::Score calculation failed with exit code $SCORE_EXIT"
            cat artifacts/trustable-report/trudag-score.txt
            exit 1
          fi

          # Verify scores were actually calculated (validators were executed)
          if grep -q "INFO: Executing validator" artifacts/trustable-report/trudag-score.txt; then
            echo "✓ Validators were executed"
          else
            echo "::error::No validators were executed!"
            echo "This indicates the .dotstop.dot graph has an issue."
            cat artifacts/trustable-report/trudag-score.txt
            exit 1
          fi

          echo "score_exit_code=$SCORE_EXIT" >> $GITHUB_OUTPUT

      - name: Generate trustable publish (optional)
        id: publish
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report
          trudag publish --output-dir artifacts/trustable-report --no-validate 2>&1 | tee artifacts/trustable-report/publish.log || true

      - name: Upload TSF validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-validation-artifacts
          path: artifacts/
          retention-days: 30

      - name: Display summary
        if: always()
        run: |
          echo "=== TSF Validation Summary ==="
          echo "Artifacts:"
          find artifacts -type f | sed -n '1,200p'
          echo ""
          if [ -f artifacts/trustable-report/trudag-score.txt ]; then
            echo "=== Trudag Score Output ==="
            head -n 100 artifacts/trustable-report/trudag-score.txt || true
          fi
          echo "============================="
