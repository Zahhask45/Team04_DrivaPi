# .github/workflows/tsf_validation.yml
name: TSF Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-generate:
    uses: ./.github/workflows/generate_verification_artifacts.yml
    with:
      use_cmake: false
      build_cmd: |
        # exemplo simples: compila o test com g++
        sudo apt-get update
        sudo apt-get install -y libgtest-dev cmake
        # tentar construir e instalar libgtest se necessÃ¡rio (non-fatal)
        if [ -d "/usr/src/googletest" ]; then
          pushd /usr/src/googletest || true
          cmake . || true
          make -j$(nproc) || true
          sudo cp -v lib/*.a /usr/lib 2>/dev/null || true
          popd || true
        fi
        mkdir -p build
        g++ -std=c++17 -I src -I tests -pthread tests/unit/test_motor_speed.cpp src/sensors/motor_speed.cpp -lgtest -lgtest_main -o build/motor_speed_test
      test_binary: build/motor_speed_test
      junit_output: artifacts/verification/tests/LLTC-998-junit.xml
      coverage_output: artifacts/verification/coverage/coverage-SWD-998.xml
      cppcheck_output: artifacts/verification/static-analysis/cppcheck-SWD-998.xml
      src_dirs: src
      run_coverage: false
      run_cppcheck: true

  tsf-validate:
    needs: build-and-generate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (needed for validators)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download verification artifacts
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          path: artifacts/verification

      - name: Install Python deps & make local validators importable
        run: |
          python -m pip install --upgrade pip
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            pip install -e .
          fi
          pip install trudag pytest pyyaml

      - name: Run trudag lint (non-fatal)
        continue-on-error: true
        run: |
          mkdir -p artifacts/trustable-report
          trudag manage lint 2>&1 | tee artifacts/trustable-report/trudag-lint.txt || true

      - name: Calculate TSF score (prefer local tsf_collect)
        id: calc
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report
          # Prefer local script if present
          if python -c "import importlib; importlib.import_module('tools.tsf_collect')" 2>/dev/null; then
            python -m tools.tsf_collect --output artifacts/trustable-report/tsf_score.json --text artifacts/trustable-report/tsf_score.txt
          else
            # fallback to trudag score if available
            if command -v trudag >/dev/null 2>&1; then
              trudag score 2>&1 | tee artifacts/trustable-report/trudag-score.txt
              cp artifacts/trustable-report/trudag-score.txt artifacts/trustable-report/tsf_score.txt || true
            else
              echo "Error: neither local tools.tsf_collect nor trudag available."
              exit 1
            fi
          fi

      - name: Upload TSF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tsf-validation-artifacts
          path: artifacts/
