name: TSF Validation (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-verification-artifacts:
    uses: ./.github/workflows/generate_verification_artifacts.yml
    with:
      test_src: 'tests/unit/test_motor_speed.cpp'
      src_dirs: 'src'
      junit_output: 'artifacts/verification/tests/LLTC-998-junit.xml'
      coverage_output: 'artifacts/verification/coverage/coverage-SWD-998.xml'
      cppcheck_output: 'artifacts/verification/static-analysis/cppcheck-SWD-998.xml'
      build_dir: 'build'

  tsf-validation:
    needs: generate-verification-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download verification artifacts produced earlier
        uses: actions/download-artifact@v4
        with:
          name: verification-artifacts
          path: artifacts/verification

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install project (editable) and tools
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel
          # Install local package in editable mode if present
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            pip install -e .
          fi

          # Install test tooling
          pip install pytest pytest-cov pyyaml

          # Install trudag (Trustable) from GitLab (pin to a tag/commit you trust)
          pip install "git+https://gitlab.com/CodethinkLabs/trustable/trustable.git@v2025.09.16#egg=trudag"

      - name: Run trudag lint (optional)
        id: trudag_lint
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report
          trudag manage lint 2>&1 | tee artifacts/trustable-report/trudag-lint.txt || true
          echo "lint_done=true" >> $GITHUB_OUTPUT

      - name: Calculate TSF scores (use local tools/tsf_collect.py if present)
        id: score
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report

          # Prefer local tsf_collect if available
          if python -c "import importlib, pkgutil, sys; sys.path.insert(0,'.'); importlib.import_module('tools.tsf_collect')" 2>/dev/null; then
            echo "Running local tools.tsf_collect"
            python -m tools.tsf_collect --output artifacts/trustable-report/tsf_score.json --text artifacts/trustable-report/tsf_score.txt
            SCORE_EXIT=$?
          else
            echo "Local tsf_collect not found â€” using trudag score"
            trudag score 2>&1 | tee artifacts/trustable-report/trudag-score.txt
            SCORE_EXIT=${PIPESTATUS[0]}
            if [ -f artifacts/trustable-report/trudag-score.txt ]; then
              cp artifacts/trustable-report/trudag-score.txt artifacts/trustable-report/tsf_score.txt || true
            fi
          fi

          echo "score_exit_code=${SCORE_EXIT}" >> $GITHUB_OUTPUT
          if [ "${SCORE_EXIT}" != "0" ]; then
            echo "::error::Score calculation returned non-zero (${SCORE_EXIT})"
            exit 1
          fi

      - name: Generate trustable publish (optional)
        id: publish
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p artifacts/trustable-report
          trudag publish --output-dir artifacts/trustable-report --no-validate 2>&1 | tee artifacts/trustable-report/publish.log || true

      - name: Upload TSF validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-validation-artifacts
          path: artifacts/
          retention-days: 30

      - name: Display summary
        if: always()
        run: |
          echo "=== TSF Validation Summary ==="
          echo "Artifacts:"
          find artifacts -type f | sed -n '1,200p'
          echo ""
          if [ -f artifacts/trustable-report/tsf_score.txt ]; then
            echo "=== TSF Score (.txt) ==="
            head -n 200 artifacts/trustable-report/tsf_score.txt || true
          elif [ -f artifacts/trustable-report/trudag-score.txt ]; then
            echo "=== Trudag Score ==="
            head -n 200 artifacts/trustable-report/trudag-score.txt || true
          fi
          echo "============================="
