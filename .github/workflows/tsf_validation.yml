name: TSF Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  tsf-validation:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ========== CHECKOUT ==========
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========== ENVIRONMENT ==========
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ========== CACHE ==========
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      # ========== DEPENDENCIES ==========
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pyyaml
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Install trudag (TSF tools)
        run: |
          git clone https://gitlab.com/CodethinkLabs/trustable/trustable.git /tmp/trustable
          cd /tmp/trustable
          git checkout 2025.9.16 || git checkout main
          pip install .

      # ========== PREPARE ==========
      - name: Create artifact directories
        run: |
          mkdir -p artifacts/verification/{tests,static-analysis,coverage}
          touch artifacts/verification/{tests,static-analysis,coverage}/.gitkeep

      # ========== TESTS & ANALYSIS ==========
      - name: Run tests with coverage
        id: tests
        continue-on-error: true
        run: |
          if [ -d "tests" ] && find tests -name "*.py" 2>/dev/null | grep -q .; then
            pytest tests/ \
              --junit-xml=artifacts/verification/tests/pytest-results.xml \
              --cov=src --cov=qt/src \
              --cov-report=xml:artifacts/verification/coverage/coverage.xml \
              2>&1 | tee artifacts/verification/tests/pytest.log
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run static analysis
        id: analysis
        continue-on-error: true
        run: |
          if [ -d "src" ] || [ -d "qt/src" ]; then
            cppcheck --enable=all --suppress=missingIncludeSystem --xml --xml-version=2 \
              src/ qt/src/ 2> artifacts/verification/static-analysis/cppcheck-results.xml
            cppcheck --enable=all --suppress=missingIncludeSystem \
              src/ qt/src/ > artifacts/verification/static-analysis/cppcheck-report.txt 2>&1 || true
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

      # ========== TSF VALIDATION ==========
      - name: Validate TSF requirements
        id: tsf
        run: |
          trudag manage lint 2>&1 | tee artifacts/trudag-lint.txt

      - name: Calculate scores
        id: score
        continue-on-error: true
        run: |
          trudag score 2>&1 | tee artifacts/trudag-score.txt

      - name: Generate report
        id: publish
        continue-on-error: true
        run: |
          mkdir -p artifacts/trustable-report
          trudag publish --output-dir artifacts/trustable-report --no-validate 2>&1 || true

      # ========== UPLOAD & REPORT ==========
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tsf-validation-artifacts
          path: artifacts/
          retention-days: 30

      # ========== DISPLAY RESULTS ==========
      - name: Display validation results
        if: always()
        run: |
          echo "=========================================="
          echo "üîç TSF VALIDATION RESULTS"
          echo "=========================================="
          echo ""
          echo "üìä Test Results: ${{ steps.tests.outputs.status }}"
          echo "üìä Analysis Results: ${{ steps.analysis.outputs.status }}"
          echo "üìä TSF Lint: ${{ steps.tsf.outcome }}"
          echo "üìä Score Calculation: ${{ steps.score.outcome }}"
          echo "üìä Report Generation: ${{ steps.publish.outcome }}"
          echo ""
          echo "=========================================="
          echo "üìã LINT OUTPUT (First 30 lines)"
          echo "=========================================="
          head -n 30 artifacts/trudag-lint.txt 2>/dev/null || echo "No lint output available"
          echo ""
          echo "=========================================="
          echo "üì¶ ARTIFACTS GENERATED"
          echo "=========================================="
          find artifacts -type f | sort
          echo ""
          echo "=========================================="
          if [ "${{ steps.tsf.outcome }}" = "success" ]; then
            echo "‚úÖ TSF VALIDATION PASSED"
          else
            echo "‚ö†Ô∏è  TSF VALIDATION NEEDS ATTENTION"
          fi
          echo "=========================================="
          echo ""
          echo "üì• Download artifacts from Actions tab"
          echo "üîó Artifact name: tsf-validation-artifacts"
          echo "==========================================="
