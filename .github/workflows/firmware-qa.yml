name: "CodeQL C Analysis for STM32 (with comments)"

on:
  push:
    branches: [feat/263-create-ci-workflow-for-static-analysis]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # weekly scan

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Cache ARM toolchain
      - name: Cache ARM Toolchain
        uses: actions/cache@v3
        with:
          path: /usr/bin/arm-none-eabi-gcc
          key: arm-toolchain-${{ runner.os }}-v1

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi make

      - name: Show ARM toolchain version
        run: arm-none-eabi-gcc --version

      # Initialize CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ['c']

      # Cache build artifacts
      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: Threadx/Debug/.build_cache
          key: stm32-build-${{ github.sha }}

      # Build project for CodeQL
      - name: Build project for CodeQL
        run: |
          cd Threadx/Debug
          make -f makefile main-build

      # Run CodeQL analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        id: codeql-analysis

      # Comment on PR if exists
      - name: Comment PR with CodeQL results
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: ${{ steps.codeql-analysis.outputs.sarif_file }}
      
      - name: Comment on PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const sarif = require('@actions/core').getInput('sarif_file');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "üîç CodeQL analysis completed. Check Security ‚Üí Code scanning alerts for details."
            });

      # Comment on commit for push events
      - name: Comment commit with CodeQL summary
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: "üîç CodeQL analysis completed for this commit. Check Security ‚Üí Code scanning alerts for details."
            });
