name: "CodeQL C Analysis for STM32"

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: codeql-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi make

      - name: Show ARM toolchain version
        run: arm-none-eabi-gcc --version

      # Initialize CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          queries: security-and-quality
          build-mode: manual
          config-file: ./.github/codeql-config.yml
          
      # Cache build artifacts
      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: Threadx/Debug/.build_cache
          key: stm32-build-${{ github.sha }}

      # Build project for CodeQL
      - name: Build project for CodeQL
        run: |
          set -e
          cd Threadx/Debug
          echo "Building firmware for CodeQL analysis..."
          
          if ! make -f makefile main-build; then
            echo "‚ùå Build failed - compilation errors detected"
            echo "Fix compilation errors before analysis can proceed"
            exit 1
          fi
          
          if [ ! -f Threadx.elf ]; then
            echo "‚ùå Build artifact missing - Threadx.elf not found"
            exit 1
          fi
          
          echo "‚úÖ Build successful - proceeding with CodeQL analysis"

      # Run CodeQL analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:cpp'
          output: results
          wait-for-processing: true

      # Filter SARIF to exclude unwanted paths (secondary safety net)
      - name: Filter SARIF results
        uses: advanced-security/filter-sarif@v1
        with:
          patterns: |
            -**/Drivers/**
            -**/Middlewares/**
            -**/AZURE_RTOS/**
            -**/Core/Startup/**
            -**/Debug/**
            -**/Release/**
          input: results/cpp.sarif
          output: results/cpp.sarif

      # Upload SARIF as downloadable artifact
      - name: Upload CodeQL SARIF report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: codeql-sarif-report
          path: results/cpp.sarif
          retention-days: 30

      # Fail job if high or critical severity issues found
      - name: Check for high-severity issues
        if: always()
        run: |
          SARIF_FILE="results/cpp.sarif"
          
          if [ ! -f "$SARIF_FILE" ]; then
            echo "‚ö†Ô∏è  SARIF file not found at $SARIF_FILE"
            exit 0
          fi
          
          # Count error-level (high/critical) results
          ERROR_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' "$SARIF_FILE" 2>/dev/null || echo 0)
          
          # Count warning-level results
          WARNING_COUNT=$(jq '[.runs[].results[] | select(.level == "warning")] | length' "$SARIF_FILE" 2>/dev/null || echo 0)
          
          echo "üìä CodeQL Analysis Summary:"
          echo "   High/Critical Issues: $ERROR_COUNT"
          echo "   Warnings: $WARNING_COUNT"
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ùå Failing job due to $ERROR_COUNT high/critical severity issue(s)"
            echo "üìç Review findings at: Security ‚Üí Code scanning alerts"
            exit 1
          else
            echo "‚úÖ No high/critical severity issues found"
          fi
