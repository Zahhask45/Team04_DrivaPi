name: "CodeQL C Analysis for STM32"

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: codeql-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi make

      - name: Show ARM toolchain version
        run: arm-none-eabi-gcc --version

      # Initialize CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          queries: security-and-quality
          build-mode: manual
          
      # Cache build artifacts
      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: Threadx/Debug/.build_cache
          key: stm32-build-${{ github.sha }}

      # Build project for CodeQL
      - name: Build project for CodeQL
        run: |
          set -e
          cd Threadx/Debug
          echo "Building firmware for CodeQL analysis..."
          
          if ! make -f makefile main-build; then
            echo "❌ Build failed - compilation errors detected"
            echo "Fix compilation errors before analysis can proceed"
            exit 1
          fi
          
          if [ ! -f Threadx.elf ]; then
            echo "❌ Build artifact missing - Threadx.elf not found"
            exit 1
          fi
          
          echo "✅ Build successful - proceeding with CodeQL analysis"

      # Run CodeQL analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:cpp'
          output: results

      # Filter SARIF to exclude unwanted paths (C++ doesn't support path filtering in manual build mode)
      - name: Filter SARIF results
        uses: advanced-security/filter-sarif@v1
        with:
          patterns: |
            -**/Drivers/**
            -**/Middlewares/**
            -**/Debug/**
            -**/AZURE_RTOS/**
            -**/Core/Startup/**
            -**/Core/Test/**
          input: results/cpp.sarif
          output: results/cpp.sarif

      # Upload SARIF as downloadable artifact
      - name: Upload CodeQL SARIF report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: codeql-sarif-report
          path: results/cpp.sarif
          retention-days: 30

      # Fail job if high or critical severity issues found
      - name: Check for high-severity issues
        if: always()
        run: |
          SARIF_FILE="results/cpp.sarif"
          
          if [ ! -f "$SARIF_FILE" ]; then
            echo "SARIF file not found at $SARIF_FILE"
            exit 0
          fi
          
          # Count error-level (high/critical) results
          # SARIF uses "error" level for high/critical severity
          ERROR_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' "$SARIF_FILE")
          
          echo "CodeQL found $ERROR_COUNT high/critical severity issue(s)"
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "❌ Failing job due to $ERROR_COUNT high/critical severity issue(s)"
            echo "Review findings at: Security → Code scanning alerts"
            exit 1
          else
            echo "✅ No high/critical severity issues found"
          fi
