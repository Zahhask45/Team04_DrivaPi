name: "CodeQL C Analysis for STM32"

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: codeql-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v6

      # Toolchain
      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-none-eabi \
            binutils-arm-none-eabi \
            make \
            jq

      - name: Show ARM toolchain version
        run: arm-none-eabi-gcc --version

      # Initialize CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          queries: security-and-quality
          build-mode: manual
          config-file: ./.github/codeql-config.yml

      # Build firmware
      - name: Build project for CodeQL
        run: |
          set -e
          cd Threadx/Debug

          echo "üî® Building firmware for CodeQL..."

          make -f makefile main-build

          test -f Threadx.elf

          echo "‚úÖ Build successful"

      # Run CodeQL analysis (do not upload yet)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:cpp'
          output: results
          upload: false
          wait-for-processing: true

      # Filter SARIF
      - name: Filter SARIF results
        uses: advanced-security/filter-sarif@v1
        with:
          # Generated code intentionally excluded
          patterns: |
            -**/Drivers/**
            -**/Middlewares/**
            -**/AZURE_RTOS/**
            -**/Core/Startup/**
            -**/Debug/**
            -**/Release/**
          input: results/cpp.sarif
          output: results/cpp.sarif

      # Upload FILTERED SARIF to GitHub Security
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results/cpp.sarif

      # Keep SARIF as artifact
      - name: Upload SARIF artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: codeql-sarif-filtered
          path: results/cpp.sarif
          retention-days: 30

      # Enforce security gate
      - name: Fail on high or critical issues
        if: always()
        run: |
          SARIF="results/cpp.sarif"

          if [ ! -f "$SARIF" ]; then
            echo "‚ö†Ô∏è SARIF not found"
            exit 0
          fi

          ERRORS=$(jq '[.runs[].results[] | select(.level=="error")] | length' "$SARIF")
          WARNINGS=$(jq '[.runs[].results[] | select(.level=="warning")] | length' "$SARIF")

          echo "üìä CodeQL results"
          echo "   High/Critical: $ERRORS"
          echo "   Warnings:      $WARNINGS"

          if [ "$ERRORS" -gt 0 ]; then
            echo "‚ùå Build failed due to high/critical issues"
            exit 1
          fi

          echo "‚úÖ No high/critical issues"