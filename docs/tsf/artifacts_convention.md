# Artifact Conventions & CI Setup

This document defines how artifacts (test results, static analysis, coverage reports) are generated, named, stored, and linked to requirements in TSF.

---

## Quick Summary

| What | Where | Action |
|------|-------|--------|
| **Tests** | `artifacts/verification/tests/` | ✅ Commit |
| **Analysis** | `artifacts/verification/static-analysis/` | ✅ Commit |
| **Coverage** | `artifacts/verification/coverage/` | ✅ Commit |
| **Reports** | `artifacts/trustable-report/` | ✅ Commit |
| **Transient** | `artifacts/traceability/`, `artifacts/reports/` | ❌ Don't commit |

---

## Directory Structure

```
artifacts/
├── verification/
│   ├── tests/               # Test results (pytest, JUnit XML)
│   ├── static-analysis/     # Code analysis (cppcheck, warnings)
│   └── coverage/            # Coverage reports (%, modules)
├── trustable-report/        # TSF reports (generated by trudag)
├── traceability/            # ❌ Temporary - don't commit
└── reports/                 # ❌ Temporary - don't commit
```

---

## Naming Conventions

### Tests
```
Pattern: LLTC-042-junit.xml
         ↓         ↓
      Req ID    Test type
```

**Examples:**
- `LLTC-042-junit.xml` (unit test result)
- `LLTC-043-integration.json` (integration test)

### Static Analysis
```
Pattern: cppcheck-SWD-042.xml
         ↓        ↓
       Tool    Req ID
```

**Examples:**
- `cppcheck-SWD-042.xml` (code analysis)
- `cppcheck-report.txt` (human-readable summary)

### Coverage
```
Pattern: coverage.xml (overall)
         or: temperature-B.lcov (module-specific)
```

---

## How It Works

### 1. GitHub Actions Runs

When you create a PR, GitHub automatically:

```bash
# Run tests
pytest tests/ --junit-xml=artifacts/verification/tests/pytest-results.xml

# Run analysis
cppcheck src/ --xml > artifacts/verification/static-analysis/cppcheck-results.xml

# Validate requirements
trudag manage lint
trudag score
trudag publish --output-dir artifacts/trustable-report
```

Result: Files appear in `artifacts/verification/`

### 2. Link in Requirements

Update your requirement file:

```yaml
---
id: LLTC-042
header: "Temperature sensor reads valid range"

references:
  - type: "file"
    path: tests/unit/test_temperature.cpp
  - type: "file"
    path: artifacts/verification/tests/LLTC-042-junit.xml

evidence:
  type: junit_pass_fail_checker
  references:
    - type: "file"
      path: artifacts/verification/tests/LLTC-042-junit.xml

score:
  TestLead: 1.0
---
```

### 3. Run Trudag

```bash
trudag manage lint    # Validates syntax
trudag score          # Calculates scores from evidence
trudag publish        # Generates reports
```

---

## .gitignore

```
# Commit these (evidence & reports)
!artifacts/verification/
!artifacts/trustable-report/

# Don't commit (regenerated each time)
artifacts/traceability/
artifacts/reports/
```

---

## Workflow Flow

```
Code → Commit → Push to PR
            ↓
GitHub Actions runs (auto)
  ├─ Tests: generates pytest-results.xml
  ├─ Analysis: generates cppcheck-results.xml
  ├─ Coverage: generates coverage.xml
            ↓
You link artifacts in requirements
  ├─ Add references: blocks
  ├─ Add evidence: blocks
  ├─ Add score: blocks
            ↓
Run trudag lint
            ↓
Run trudag score
            ↓
Run trudag publish
            ↓
Commit requirements
            ↓
PR → Review → Merge ✅
            ↓
Artifacts stored in Git forever
```

---

## Examples

### Example 1: Link Test Results

```yaml
---
id: LLTC-042

references:
  - type: "file"
    path: artifacts/verification/tests/LLTC-042-junit.xml

score:
  TestLead: 1.0
---
```

### Example 2: Link Code Analysis

```yaml
---
id: SWD-042

references:
  - type: "file"
    path: src/sensors/temperature.cpp
  - type: "file"
    path: artifacts/verification/static-analysis/cppcheck-SWD-042.xml

evidence:
  type: cppcheck_error_validator
  references:
    - type: "file"
      path: artifacts/verification/static-analysis/cppcheck-SWD-042.xml
  configuration:
    fail_on_severity: ["error"]

score:
  CodeReviewer: 0.9
---
```

### Example 3: Multiple Evidence

```yaml
---
id: SRD-015

references:
  - type: "file"
    path: docs/design/system.md
  - type: "file"
    path: src/sensors/temperature.cpp
  - type: "file"
    path: artifacts/verification/tests/LLTC-042-junit.xml
  - type: "file"
    path: artifacts/verification/coverage/coverage.xml

score:
  SystemArchitect: 0.85
  TestLead: 0.9
---
```

---

## Best Practices

1. **Name by requirement ID** → `LLTC-042-junit.xml` ✅
2. **Use standard formats** → JUnit XML, Cobertura XML ✅
3. **Commit artifacts** → Part of git history ✅
4. **Link early** → As you develop ✅
5. **Update after changes** → Re-run CI if code changes ✅

---

## Troubleshooting

### Artifacts not generated?
```bash
# Check directories exist
ls -la src/
ls -la tests/

# Run manually
pytest tests/ --junit-xml=artifacts/verification/tests/test.xml
cppcheck src/ --xml > artifacts/verification/static-analysis/report.xml
```

### Broken paths in references?
```bash
# Verify path exists (from repo root)
ls -la artifacts/verification/tests/LLTC-042-junit.xml

# Correct format: artifacts/verification/tests/LLTC-042-junit.xml
# Wrong format: /artifacts/... or ../artifacts/...
```

### Git showing artifacts as modified?
```bash
# This is expected! Commit them:
git add artifacts/verification/
git commit -m "ci: Update TSF artifacts"
```

---

## Related Documentation

- **Evidence Linking:** See `docs/tsf/evidence.md`
- **TSF Commands:** See `docs/tsf/reference.md`
- **GitHub Workflow:** See `.github/workflows/tsf-validation.yml`
